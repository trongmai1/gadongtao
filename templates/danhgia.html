<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω ƒë√°nh gi√°</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
<div class="container mx-auto p-4">
    <h1 class="text-2xl font-bold mb-4 text-indigo-700">üìù Qu·∫£n l√Ω ƒë√°nh gi√° theo ti√™u ch√≠</h1>
    <a href="/" class="text-blue-500 hover:underline mb-4 inline-block">‚Üê Quay l·∫°i trang ch·ªß</a>

    <div class="bg-white p-4 rounded shadow mb-6">
        <h2 class="text-xl font-semibold mb-3">Ch·ªçn sinh vi√™n + h·ªçc k·ª≥</h2>
        <div class="grid md:grid-cols-2 gap-4">
            <select id="IDSINHVIEN" class="border p-2 rounded" required>
                <option value="">Ch·ªçn sinh vi√™n</option>
            </select>
            <select id="IDHOCKY" class="border p-2 rounded" required>
                <option value="">Ch·ªçn h·ªçc k·ª≥</option>
            </select>
            <div class="border p-2 rounded overflow-auto max-h-48" id="tieuchiCheckboxes">
                <p class="text-sm text-gray-500">ƒêang t·∫£i ti√™u ch√≠...</p>
            </div>
            <input id="SVDANHGIA" type="number" placeholder="ƒêi·ªÉm SV t·ª± ƒë√°nh gi√° (0‚Äì25)" class="border p-2 rounded" min="0" max="25" required>
            <input id="CANBODANHGIA" type="number" placeholder="ƒêi·ªÉm c√°n b·ªô ƒë√°nh gi√° (0‚Äì25)" class="border p-2 rounded" min="0" max="25" required>
            <input id="CVHTXACNHAN" type="number" placeholder="ƒêi·ªÉm CVHT x√°c nh·∫≠n (0‚Äì25)" class="border p-2 rounded" min="0" max="25" required>
            <div class="flex space-x-2 col-span-full md:col-span-1">
                <button id="saveButton" onclick="addOrUpdateDanhGia()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">üíæ L∆∞u</button>
                <button id="cancelButton" onclick="clearForm()" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500 transition hidden">üö´ H·ªßy</button>
            </div>
        </div>
    </div>

    <div class="bg-white rounded shadow overflow-x-auto">
        <table class="min-w-full border-collapse border border-gray-300">
            <thead class="bg-gray-200 text-gray-700">
                <tr>
                    <th class="border p-2">M√£ sinh vi√™n</th>
                    <th class="border p-2">H·ªçc k·ª≥</th>
                    <th class="border p-2">M√£ ti√™u ch√≠</th>
                    <th class="border p-2">SV t·ª± ƒë√°nh gi√°</th>
                    <th class="border p-2">C√°n b·ªô ƒë√°nh gi√°</th>
                    <th class="border p-2">CVHT x√°c nh·∫≠n</th>
                    <th class="border p-2">H√†nh ƒë·ªông</th>
                </tr>
            </thead>
            <tbody id="danhgiaTable" class="text-sm"></tbody>
        </table>
    </div>
</div>

<script>
    let sinhvienMap = {};
    let hockyMap = {};

    function escapeHTML(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    async function loadSinhVienDropdown() {
        try {
            const res = await fetch('/api/sinhvien');
            if (!res.ok) throw new Error(await res.text());
            const data = await res.json();
            const select = document.getElementById('IDSINHVIEN');
            select.innerHTML = '<option value="">Ch·ªçn sinh vi√™n</option>';
            data.forEach(sv => {
                sinhvienMap[sv.IDSINHVIEN] = sv.HOVATEN;
                const option = document.createElement('option');
                option.value = sv.IDSINHVIEN;
                option.textContent = `${escapeHTML(sv.IDSINHVIEN)} - ${escapeHTML(sv.HOVATEN)}`;
                select.appendChild(option);
            });
        } catch (error) {
            alert('L·ªói khi t·∫£i danh s√°ch sinh vi√™n: ' + (error.message || 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server'));
        }
    }

    async function loadHocKyDropdown() {
        try {
            const res = await fetch('/api/hocky');
            if (!res.ok) throw new Error(await res.text());
            const data = await res.json();
            const select = document.getElementById('IDHOCKY');
            select.innerHTML = '<option value="">Ch·ªçn h·ªçc k·ª≥</option>';
            data.forEach(hk => {
                hockyMap[hk.IDHOCKY] = hk.TENHK;
                const option = document.createElement('option');
                option.value = hk.IDHOCKY;
                option.textContent = `${escapeHTML(hk.IDHOCKY)} - ${escapeHTML(hk.TENHK)}`;
                select.appendChild(option);
            });
        } catch (error) {
            alert('L·ªói khi t·∫£i danh s√°ch h·ªçc k·ª≥: ' + (error.message || 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server'));
        }
    }

    async function loadTieuChiCheckboxes() {
        try {
            const res = await fetch('/api/tieuchi');
            if (!res.ok) throw new Error(await res.text());
            const data = await res.json();
            const container = document.getElementById('tieuchiCheckboxes');
            container.innerHTML = '';
            if (data.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-500">Kh√¥ng c√≥ ti√™u ch√≠ n√†o.</p>';
                return;
            }
            data.forEach(tc => {
                const div = document.createElement('div');
                div.className = "flex items-center gap-2 mb-1";
                div.innerHTML = `
                    <input type="checkbox" id="tc-${escapeHTML(tc.IDTIEUCHI)}" value="${escapeHTML(tc.IDTIEUCHI)}">
                    <label for="tc-${escapeHTML(tc.IDTIEUCHI)}" class="text-sm">${escapeHTML(tc.IDTIEUCHI)} - ${escapeHTML(tc.TENTIEUCHI)}</label>
                `;
                container.appendChild(div);
            });
        } catch (error) {
            alert('L·ªói khi t·∫£i danh s√°ch ti√™u ch√≠: ' + (error.message || 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server'));
        }
    }

    async function loadDanhGia() {
        try {
            const res = await fetch('/api/danhgia');
            if (!res.ok) throw new Error(await res.text());
            const data = await res.json();
            const tbody = document.getElementById('danhgiaTable');
            tbody.innerHTML = '';
            for (const dg of data) {
                const [IDSINHVIEN, IDHOCKY] = dg.IDPHIEU.split('-');
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="border p-2">${escapeHTML(IDSINHVIEN)}</td>
                    <td class="border p-2">${escapeHTML(hockyMap[IDHOCKY] || IDHOCKY)}</td>
                    <td class="border p-2">${escapeHTML(dg.IDTIEUCHI)}</td>
                    <td class="border p-2">${dg.SVDANHGIA}</td>
                    <td class="border p-2">${dg.CANBODANHGIA}</td>
                    <td class="border p-2">${dg.CVHTXACNHAN}</td>
                    <td class="border p-2 space-x-1">
                        <button onclick="editDanhGia('${escapeHTML(dg.IDPHIEU)}', '${escapeHTML(dg.IDTIEUCHI)}', ${dg.SVDANHGIA}, ${dg.CANBODANHGIA}, ${dg.CVHTXACNHAN})" class="bg-yellow-500 text-white px-2 py-1 rounded hover:bg-yellow-600">‚úèÔ∏è S·ª≠a</button>
                        <button onclick="deleteDanhGia('${escapeHTML(dg.IDPHIEU)}', '${escapeHTML(dg.IDTIEUCHI)}')" class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">üóëÔ∏è X√≥a</button>
                    </td>
                `;
                tbody.appendChild(row);
            }
        } catch (error) {
            alert('L·ªói khi t·∫£i danh s√°ch ƒë√°nh gi√°: ' + (error.message || 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server'));
        }
    }

    async function addOrUpdateDanhGia() {
        const IDSINHVIEN = document.getElementById('IDSINHVIEN').value;
        const IDHOCKY = document.getElementById('IDHOCKY').value;
        const SVDANHGIA = parseInt(document.getElementById('SVDANHGIA').value);
        const CANBODANHGIA = parseInt(document.getElementById('CANBODANHGIA').value);
        const CVHTXACNHAN = parseInt(document.getElementById('CVHTXACNHAN').value);
        const checked = Array.from(document.querySelectorAll('#tieuchiCheckboxes input:checked')).map(el => el.value);

        // Validation
        if (!IDSINHVIEN || !IDHOCKY || checked.length === 0) {
            alert('Vui l√≤ng ch·ªçn sinh vi√™n, h·ªçc k·ª≥ v√† √≠t nh·∫•t m·ªôt ti√™u ch√≠.');
            return;
        }
        if ([SVDANHGIA, CANBODANHGIA, CVHTXACNHAN].some(d => isNaN(d) || d < 0 || d > 25)) {
            alert('T·∫•t c·∫£ ƒëi·ªÉm ph·∫£i t·ª´ 0 ƒë·∫øn 25.');
            return;
        }

        const IDPHIEU = `${IDSINHVIEN}-${IDHOCKY}`;
        for (const IDTIEUCHI of checked) {
            try {
                const resCheck = await fetch(`/api/danhgia?IDSINHVIEN=${encodeURIComponent(IDSINHVIEN)}&IDHOCKY=${encodeURIComponent(IDHOCKY)}&IDTIEUCHI=${encodeURIComponent(IDTIEUCHI)}`);
                const method = resCheck.ok ? 'PUT' : 'POST';
                const url = method === 'POST' ? '/api/danhgia' : `/api/danhgia?IDSINHVIEN=${encodeURIComponent(IDSINHVIEN)}&IDHOCKY=${encodeURIComponent(IDHOCKY)}&IDTIEUCHI=${encodeURIComponent(IDTIEUCHI)}`;
                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ IDPHIEU, IDTIEUCHI, SVDANHGIA, CANBODANHGIA, CVHTXACNHAN })
                });

                if (!res.ok) {
                    const errorData = await res.json();
                    alert(`L·ªói khi l∆∞u ti√™u ch√≠ ${IDTIEUCHI}: ${errorData.detail || 'Kh√¥ng th·ªÉ th·ª±c hi·ªán y√™u c·∫ßu'}`);
                    return;
                }
            } catch (error) {
                alert(`L·ªói khi g·ª≠i y√™u c·∫ßu cho ti√™u ch√≠ ${IDTIEUCHI}: ${error.message || 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server'}`);
                return;
            }
        }

        alert('L∆∞u ƒë√°nh gi√° th√†nh c√¥ng!');
        clearForm();
        loadDanhGia();
    }

    function editDanhGia(IDPHIEU, IDTIEUCHI, SVDANHGIA, CANBODANHGIA, CVHTXACNHAN) {
        const [IDSINHVIEN, IDHOCKY] = IDPHIEU.split('-');
        document.getElementById('IDSINHVIEN').value = IDSINHVIEN;
        document.getElementById('IDHOCKY').value = IDHOCKY;
        document.querySelectorAll('#tieuchiCheckboxes input').forEach(el => el.checked = el.value === IDTIEUCHI);
        document.getElementById('SVDANHGIA').value = SVDANHGIA;
        document.getElementById('CANBODANHGIA').value = CANBODANHGIA;
        document.getElementById('CVHTXACNHAN').value = CVHTXACNHAN;
        document.getElementById('saveButton').textContent = 'C·∫≠p nh·∫≠t';
        document.getElementById('cancelButton').classList.remove('hidden');
    }

    async function deleteDanhGia(IDPHIEU, IDTIEUCHI) {
        const [IDSINHVIEN, IDHOCKY] = IDPHIEU.split('-');
        if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ƒë√°nh gi√° ti√™u ch√≠ ${IDTIEUCHI} cho sinh vi√™n ${IDSINHVIEN} trong h·ªçc k·ª≥ ${IDHOCKY}?`)) {
            try {
                const res = await fetch(`/api/danhgia?IDSINHVIEN=${encodeURIComponent(IDSINHVIEN)}&IDHOCKY=${encodeURIComponent(IDHOCKY)}&IDTIEUCHI=${encodeURIComponent(IDTIEUCHI)}`, { method: 'DELETE' });
                if (res.ok) {
                    alert('X√≥a ƒë√°nh gi√° th√†nh c√¥ng!');
                    loadDanhGia();
                } else {
                    const errorData = await res.json();
                    alert('L·ªói khi x√≥a: ' + (errorData.detail || 'Kh√¥ng th·ªÉ x√≥a ƒë√°nh gi√°'));
                }
            } catch (error) {
                alert('L·ªói khi g·ª≠i y√™u c·∫ßu x√≥a: ' + (error.message || 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server'));
            }
        }
    }

    function clearForm() {
        document.getElementById('IDSINHVIEN').value = '';
        document.getElementById('IDHOCKY').value = '';
        document.getElementById('SVDANHGIA').value = '';
        document.getElementById('CANBODANHGIA').value = '';
        document.getElementById('CVHTXACNHAN').value = '';
        document.querySelectorAll('#tieuchiCheckboxes input').forEach(el => el.checked = false);
        document.getElementById('saveButton').textContent = ' L∆∞u';
        document.getElementById('cancelButton').classList.add('hidden');
    }

    window.onload = async () => {
        await loadSinhVienDropdown();
        await loadHocKyDropdown();
        await loadTieuChiCheckboxes();
        await loadDanhGia();
    };
</script>
</body>
</html>