<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω ƒë√°nh gi√° r√®n luy·ªán</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
<div class="container mx-auto p-4">
    <h1 class="text-2xl font-bold text-indigo-700 mb-4">üìã Qu·∫£n l√Ω ƒë√°nh gi√° r√®n luy·ªán</h1>
    <a href="/" class="text-blue-500 hover:underline mb-4 inline-block">‚Üê Quay l·∫°i trang ch·ªß</a>

    <!-- Form -->
    <div class="bg-white p-4 rounded shadow mb-6">
        <h2 class="text-xl font-semibold mb-2">Th√™m / S·ª≠a ƒë√°nh gi√°</h2>
        <div class="grid md:grid-cols-2 gap-4">
            <input id="IDPHIEU" type="text" placeholder="M√£ phi·∫øu (Pxxx)" class="border p-2 rounded" pattern="P[0-9]{3}" title="M√£ phi·∫øu ph·∫£i b·∫Øt ƒë·∫ßu b·∫±ng 'P' v√† theo sau l√† 3 ch·ªØ s·ªë (v√≠ d·ª•: P001)" required>
            <select id="IDTIEUCHI" class="border p-2 rounded" required>
                <option value="">Ch·ªçn ti√™u ch√≠</option>
            </select>
            <input id="SVDANHGIA" type="number" placeholder="ƒêi·ªÉm t·ª± ƒë√°nh gi√° (0-100)" class="border p-2 rounded" min="0" max="100" required>
            <input id="CANBODANHGIA" type="number" placeholder="ƒêi·ªÉm c√°n b·ªô (0-100)" class="border p-2 rounded" min="0" max="100" required>
            <select id="CVHTXACNHAN" class="border p-2 rounded" required>
                <option value="">Ch·ªçn x√°c nh·∫≠n</option>
                <option value="1">ƒê·ªìng √Ω</option>
                <option value="0">Kh√¥ng ƒë·ªìng √Ω</option>
            </select>
            <div class="flex space-x-2 col-span-full md:col-span-1">
                <button id="saveButton" onclick="addOrUpdateDanhGia()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">üíæ L∆∞u</button>
                <button id="cancelButton" onclick="clearForm()" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500 transition hidden">üö´ H·ªßy</button>
            </div>
        </div>
    </div>

    <!-- Table -->
    <div class="bg-white rounded shadow overflow-x-auto">
        <table class="min-w-full border-collapse border border-gray-300">
            <thead class="bg-gray-200 text-gray-700">
                <tr>
                    <th class="border p-2">M√£ phi·∫øu</th>
                    <th class="border p-2">Ti√™u ch√≠</th>
                    <th class="border p-2">ƒêi·ªÉm t·ª± ƒë√°nh gi√°</th>
                    <th class="border p-2">ƒêi·ªÉm c√°n b·ªô</th>
                    <th class="border p-2">X√°c nh·∫≠n CVHT</th>
                    <th class="border p-2">H√†nh ƒë·ªông</th>
                </tr>
            </thead>
            <tbody id="danhgiaTable" class="text-sm"></tbody>
        </table>
    </div>
</div>

<script>
    let tieuChiMap = {};

    // H√†m tho√°t k√Ω t·ª± HTML ƒë·ªÉ tr√°nh XSS
    function escapeHTML(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    async function loadTieuChiDropdown() {
        try {
            const res = await fetch('/api/tieuchi');
            if (!res.ok) throw new Error(await res.text());
            const data = await res.json();
            const select = document.getElementById('IDTIEUCHI');
            select.innerHTML = '<option value="">Ch·ªçn ti√™u ch√≠</option>';
            data.forEach(tc => {
                tieuChiMap[tc.IDTIEUCHI] = tc.TENTIEUCHI;
                const opt = document.createElement('option');
                opt.value = tc.IDTIEUCHI;
                opt.textContent = `${escapeHTML(tc.IDTIEUCHI)} - ${escapeHTML(tc.TENTIEUCHI)}`;
                select.appendChild(opt);
            });
        } catch (error) {
            alert('L·ªói khi t·∫£i danh s√°ch ti√™u ch√≠: ' + (error.message || 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server'));
        }
    }

    async function loadDanhGia() {
        try {
            const res = await fetch('/api/danhgia');
            if (!res.ok) throw new Error(await res.text());
            const data = await res.json();
            const tbody = document.getElementById('danhgiaTable');
            tbody.innerHTML = '';
            data.forEach(dg => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="border p-2">${escapeHTML(dg.IDPHIEU)}</td>
                    <td class="border p-2">${escapeHTML(tieuChiMap[dg.IDTIEUCHI] || dg.IDTIEUCHI)}</td>
                    <td class="border p-2">${dg.SVDANHGIA}</td>
                    <td class="border p-2">${dg.CANBODANHGIA}</td>
                    <td class="border p-2">${dg.CVHTXACNHAN === 1 ? 'ƒê·ªìng √Ω' : 'Kh√¥ng ƒë·ªìng √Ω'}</td>
                    <td class="border p-2 space-x-1">
                        <button onclick="editDanhGia('${escapeHTML(dg.IDPHIEU)}', '${escapeHTML(dg.IDTIEUCHI)}', ${dg.SVDANHGIA}, ${dg.CANBODANHGIA}, ${dg.CVHTXACNHAN})" class="bg-yellow-500 text-white px-2 py-1 rounded hover:bg-yellow-600">‚úèÔ∏è S·ª≠a</button>
                        <button onclick="deleteDanhGia('${escapeHTML(dg.IDPHIEU)}', '${escapeHTML(dg.IDTIEUCHI)}')" class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">üóëÔ∏è X√≥a</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        } catch (error) {
            alert('L·ªói khi t·∫£i danh s√°ch ƒë√°nh gi√°: ' + (error.message || 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server'));
        }
    }

    async function addOrUpdateDanhGia() {
        const IDPHIEU = document.getElementById('IDPHIEU').value.trim();
        const IDTIEUCHI = document.getElementById('IDTIEUCHI').value;
        const SVDANHGIA = parseInt(document.getElementById('SVDANHGIA').value);
        const CANBODANHGIA = parseInt(document.getElementById('CANBODANHGIA').value);
        const CVHTXACNHAN = document.getElementById('CVHTXACNHAN').value;

        // Validation
        if (!IDPHIEU || !IDTIEUCHI || isNaN(SVDANHGIA) || isNaN(CANBODANHGIA) || !CVHTXACNHAN) {
            alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin (M√£ phi·∫øu, Ti√™u ch√≠, ƒêi·ªÉm t·ª± ƒë√°nh gi√°, ƒêi·ªÉm c√°n b·ªô, X√°c nh·∫≠n).');
            return;
        }
        if (!/P[0-9]{3}/.test(IDPHIEU)) {
            alert('M√£ phi·∫øu ph·∫£i b·∫Øt ƒë·∫ßu b·∫±ng "P" v√† theo sau l√† 3 ch·ªØ s·ªë (v√≠ d·ª•: P001).');
            return;
        }
        if (SVDANHGIA < 0 || SVDANHGIA > 100 || CANBODANHGIA < 0 || CANBODANHGIA > 100) {
            alert('ƒêi·ªÉm t·ª± ƒë√°nh gi√° v√† ƒëi·ªÉm c√°n b·ªô ph·∫£i t·ª´ 0 ƒë·∫øn 100.');
            return;
        }

        const method = document.getElementById('saveButton').textContent.includes('C·∫≠p nh·∫≠t') ? 'PUT' : 'POST';
        const url = method === 'POST' ? '/api/danhgia' : `/api/danhgia/${IDPHIEU}/${IDTIEUCHI}`;

        const formData = new URLSearchParams({
            IDPHIEU,
            IDTIEUCHI,
            SVDANHGIA: SVDANHGIA.toString(),
            CANBODANHGIA: CANBODANHGIA.toString(),
            CVHTXACNHAN
        });

        try {
            const res = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: formData
            });

            if (res.ok) {
                alert(method === 'POST' ? 'Th√™m ƒë√°nh gi√° th√†nh c√¥ng!' : 'C·∫≠p nh·∫≠t ƒë√°nh gi√° th√†nh c√¥ng!');
                clearForm();
                loadDanhGia();
                // C·∫≠p nh·∫≠t phi·∫øu ƒëi·ªÉm n·∫øu c·∫ßn (t√≠nh t·ªïng ƒëi·ªÉm)
                updatePhieuDiem(IDPHIEU);
            } else {
                const errorData = await res.json();
                alert('L·ªói: ' + (errorData.detail || 'Kh√¥ng th·ªÉ th·ª±c hi·ªán y√™u c·∫ßu'));
            }
        } catch (error) {
            alert('L·ªói khi g·ª≠i y√™u c·∫ßu: ' + (error.message || 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server'));
        }
    }

    async function updatePhieuDiem(IDPHIEU) {
        try {
            const res = await fetch(`/api/phieudiem/${IDPHIEU}`);
            if (!res.ok) throw new Error(await res.text());
            const phieu = (await res.json())[0];
            const danhGiaRes = await fetch(`/api/danhgia?IDPHIEU=${IDPHIEU}`);
            if (!danhGiaRes.ok) throw new Error(await danhGiaRes.text());
            const danhGiaData = await danhGiaRes.json();
            const tongDiem = calculateTongDiem(danhGiaData);
            const xepLoai = getXepLoai(tongDiem);
            const formData = new URLSearchParams({
                IDPHIEU,
                IDSINHVIEN: phieu.IDSINHVIEN,
                IDHOCKY: phieu.IDHOCKY,
                TONGDIEM: tongDiem.toString(),
                XEPLOAI: xepLoai,
                GHICHU: phieu.GHICHU || ''
            });
            const updateRes = await fetch(`/api/phieudiem/${IDPHIEU}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: formData
            });
            if (!updateRes.ok) throw new Error(await updateRes.text());
        } catch (error) {
            console.error('L·ªói khi c·∫≠p nh·∫≠t phi·∫øu ƒëi·ªÉm:', error);
        }
    }

    function calculateTongDiem(danhGiaData) {
        if (!danhGiaData.length) return 0;
        const avg = danhGiaData.reduce((sum, dg) => sum + (dg.SVDANHGIA + dg.CANBODANHGIA) / 2, 0) / danhGiaData.length;
        return danhGiaData.every(dg => dg.CVHTXACNHAN === '1') ? avg : avg * 0.9; // Gi·∫£m 10% n·∫øu kh√¥ng ƒë·ªìng √Ω
    }

    function getXepLoai(tongDiem) {
        if (tongDiem >= 90) return 'Xu·∫•t s·∫Øc';
        if (tongDiem >= 80) return 'T·ªët';
        if (tongDiem >= 65) return 'Kh√°';
        if (tongDiem >= 50) return 'Trung b√¨nh';
        return 'Y·∫øu';
    }

    function editDanhGia(IDPHIEU, IDTIEUCHI, SVDANHGIA, CANBODANHGIA, CVHTXACNHAN) {
        document.getElementById('IDPHIEU').value = IDPHIEU;
        document.getElementById('IDTIEUCHI').value = IDTIEUCHI;
        document.getElementById('SVDANHGIA').value = SVDANHGIA;
        document.getElementById('CANBODANHGIA').value = CANBODANHGIA;
        document.getElementById('CVHTXACNHAN').value = CVHTXACNHAN;
        document.getElementById('saveButton').textContent = 'üìù C·∫≠p nh·∫≠t';
        document.getElementById('cancelButton').classList.remove('hidden');
    }

    async function deleteDanhGia(IDPHIEU, IDTIEUCHI) {
        if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ƒë√°nh gi√° v·ªõi m√£ phi·∫øu ${IDPHIEU} v√† ti√™u ch√≠ ${IDTIEUCHI}?`)) {
            try {
                const res = await fetch(`/api/danhgia/${IDPHIEU}/${IDTIEUCHI}`, { method: 'DELETE' });
                if (res.ok) {
                    alert('X√≥a ƒë√°nh gi√° th√†nh c√¥ng!');
                    loadDanhGia();
                    updatePhieuDiem(IDPHIEU); // C·∫≠p nh·∫≠t phi·∫øu ƒëi·ªÉm sau khi x√≥a
                } else {
                    const errorData = await res.json();
                    alert('L·ªói khi x√≥a: ' + (errorData.detail || 'Kh√¥ng th·ªÉ x√≥a ƒë√°nh gi√°'));
                }
            } catch (error) {
                alert('L·ªói khi g·ª≠i y√™u c·∫ßu x√≥a: ' + (error.message || 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server'));
            }
        }
    }

    function clearForm() {
        document.getElementById('IDPHIEU').value = '';
        document.getElementById('IDTIEUCHI').value = '';
        document.getElementById('SVDANHGIA').value = '';
        document.getElementById('CANBODANHGIA').value = '';
        document.getElementById('CVHTXACNHAN').value = '';
        document.getElementById('saveButton').textContent = 'üíæ L∆∞u';
        document.getElementById('cancelButton').classList.add('hidden');
    }

    window.onload = async () => {
        await loadTieuChiDropdown();
        await loadDanhGia();
    };
</script>
</body>
</html>