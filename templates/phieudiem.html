<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω phi·∫øu ƒëi·ªÉm r√®n luy·ªán</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
<div class="container mx-auto p-4">
    <h1 class="text-2xl font-bold text-indigo-700 mb-4">üìÑ Qu·∫£n l√Ω phi·∫øu ƒëi·ªÉm r√®n luy·ªán</h1>
    <a href="/" class="text-blue-500 hover:underline mb-4 inline-block">‚Üê Quay l·∫°i trang ch·ªß</a>

    <!-- Form -->
    <div class="bg-white p-4 rounded shadow mb-6">
        <h2 class="text-xl font-semibold mb-2">Th√™m / S·ª≠a phi·∫øu ƒëi·ªÉm</h2>
        <div class="grid md:grid-cols-2 gap-4">
            <select id="IDSINHVIEN" class="border p-2 rounded" required>
                <option value="">Ch·ªçn sinh vi√™n</option>
            </select>
            <select id="IDHOCKY" class="border p-2 rounded" required>
                <option value="">Ch·ªçn h·ªçc k·ª≥</option>
            </select>
            <select id="IDDANHGIA" class="border p-2 rounded" required>
                <option value="">Ch·ªçn ƒë√°nh gi√°</option>
            </select>
            <input id="TONGDIEM" type="number" placeholder="T·ªïng ƒëi·ªÉm (0-100)" class="border p-2 rounded" min="0" max="100" required>
            <input id="XEPLOAI" type="text" placeholder="X·∫øp lo·∫°i (Xu·∫•t s·∫Øc, T·ªët, Kh√°, Trung b√¨nh, Y·∫øu)" class="border p-2 rounded" required>
            <input id="GHICHU" type="text" placeholder="Ghi ch√∫" class="border p-2 rounded">
            <div class="flex space-x-2 col-span-full md:col-span-1">
                <button id="saveButton" onclick="addOrUpdatePhieuDiem()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">üíæ L∆∞u</button>
                <button id="cancelButton" onclick="clearForm()" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500 transition hidden">üö´ H·ªßy</button>
            </div>
        </div>
    </div>

    <!-- Table -->
    <div class="bg-white rounded shadow overflow-x-auto">
        <table class="min-w-full border-collapse border border-gray-300">
            <thead class="bg-gray-200 text-gray-700">
                <tr>
                    <th class="border p-2">M√£ SV</th>
                    <th class="border p-2">T√™n SV</th>
                    <th class="border p-2">H·ªçc k·ª≥</th>
                    <th class="border p-2">ƒê√°nh gi√°</th>
                    <th class="border p-2">T·ªïng ƒëi·ªÉm</th>
                    <th class="border p-2">X·∫øp lo·∫°i</th>
                    <th class="border p-2">Ghi ch√∫</th>
                    <th class="border p-2">H√†nh ƒë·ªông</th>
                </tr>
            </thead>
            <tbody id="phieudiemTable" class="text-sm"></tbody>
        </table>
    </div>
</div>

<script>
    let sinhvienMap = {};
    let hockyMap = {};
    let danhgiaMap = {};

    // H√†m tho√°t k√Ω t·ª± HTML ƒë·ªÉ tr√°nh XSS
    function escapeHTML(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    async function loadSinhVienDropdown() {
        try {
            const res = await fetch('/api/sinhvien');
            if (!res.ok) throw new Error(await res.text());
            const data = await res.json();
            const select = document.getElementById('IDSINHVIEN');
            select.innerHTML = '<option value="">Ch·ªçn sinh vi√™n</option>';
            data.forEach(sv => {
                sinhvienMap[sv.IDSINHVIEN] = sv.HOVATEN;
                const opt = document.createElement('option');
                opt.value = sv.IDSINHVIEN;
                opt.textContent = `${escapeHTML(sv.IDSINHVIEN)} - ${escapeHTML(sv.HOVATEN)}`;
                select.appendChild(opt);
            });
        } catch (error) {
            alert('L·ªói khi t·∫£i danh s√°ch sinh vi√™n: ' + (error.message || 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server'));
        }
    }

    async function loadHocKyDropdown() {
        try {
            const res = await fetch('/api/hocky');
            if (!res.ok) throw new Error(await res.text());
            const data = await res.json();
            const select = document.getElementById('IDHOCKY');
            select.innerHTML = '<option value="">Ch·ªçn h·ªçc k·ª≥</option>';
            data.forEach(hk => {
                hockyMap[hk.IDHOCKY] = hk.TENHK;
                const opt = document.createElement('option');
                opt.value = hk.IDHOCKY;
                opt.textContent = `${escapeHTML(hk.IDHOCKY)} - ${escapeHTML(hk.TENHK)}`;
                select.appendChild(opt);
            });
        } catch (error) {
            alert('L·ªói khi t·∫£i danh s√°ch h·ªçc k·ª≥: ' + (error.message || 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server'));
        }
    }

    async function loadDanhGiaDropdown() {
        try {
            const res = await fetch('/api/danhgia');
            if (!res.ok) throw new Error(await res.text());
            const data = await res.json();
            const select = document.getElementById('IDDANHGIA');
            select.innerHTML = '<option value="">Ch·ªçn ƒë√°nh gi√°</option>';
            data.forEach(dg => {
                danhgiaMap[dg.IDDANHGIA] = dg.IDTIEUCHI;
                const opt = document.createElement('option');
                opt.value = dg.IDDANHGIA;
                opt.textContent = `${escapeHTML(dg.IDDANHGIA)} - ${escapeHTML(dg.IDTIEUCHI)}`;
                select.appendChild(opt);
            });
        } catch (error) {
            alert('L·ªói khi t·∫£i danh s√°ch ƒë√°nh gi√°: ' + (error.message || 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server'));
        }
    }

    async function loadPhieuDiem() {
        try {
            const res = await fetch('/api/phieudiem');
            if (!res.ok) throw new Error(await res.text());
            const data = await res.json();
            const tbody = document.getElementById('phieudiemTable');
            tbody.innerHTML = '';
            data.forEach(p => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="border p-2">${escapeHTML(p.IDSINHVIEN)}</td>
                    <td class="border p-2">${escapeHTML(sinhvienMap[p.IDSINHVIEN] || '')}</td>
                    <td class="border p-2">${escapeHTML(hockyMap[p.IDHOCKY] || '')}</td>
                    <td class="border p-2">${escapeHTML(p.IDDANHGIA)}</td>
                    <td class="border p-2">${p.TONGDIEM}</td>
                    <td class="border p-2">${escapeHTML(p.XEPLOAI)}</td>
                    <td class="border p-2">${escapeHTML(p.GHICHU || '')}</td>
                    <td class="border p-2 space-x-1">
                        <button onclick="editPhieuDiem('${escapeHTML(p.IDSINHVIEN)}', '${escapeHTML(p.IDHOCKY)}', '${escapeHTML(p.IDDANHGIA)}', ${p.TONGDIEM}, '${escapeHTML(p.XEPLOAI)}', '${escapeHTML(p.GHICHU || '')}')" class="bg-yellow-500 text-white px-2 py-1 rounded hover:bg-yellow-600">‚úèÔ∏è S·ª≠a</button>
                        <button onclick="deletePhieuDiem('${escapeHTML(p.IDSINHVIEN)}', '${escapeHTML(p.IDHOCKY)}', '${escapeHTML(p.IDDANHGIA)}')" class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">üóëÔ∏è X√≥a</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        } catch (error) {
            alert('L·ªói khi t·∫£i danh s√°ch phi·∫øu ƒëi·ªÉm: ' + (error.message || 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server'));
        }
    }

    async function addOrUpdatePhieuDiem() {
        const IDSINHVIEN = document.getElementById('IDSINHVIEN').value;
        const IDHOCKY = document.getElementById('IDHOCKY').value;
        const IDDANHGIA = document.getElementById('IDDANHGIA').value;
        const TONGDIEM = parseInt(document.getElementById('TONGDIEM').value);
        const XEPLOAI = document.getElementById('XEPLOAI').value.trim();
        const GHICHU = document.getElementById('GHICHU').value.trim() || '';

        // Validation
        if (!IDSINHVIEN || !IDHOCKY || !IDDANHGIA || isNaN(TONGDIEM) || !XEPLOAI) {
            alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin (Sinh vi√™n, H·ªçc k·ª≥, ƒê√°nh gi√°, T·ªïng ƒëi·ªÉm, X·∫øp lo·∫°i).');
            return;
        }
        if (TONGDIEM < 0 || TONGDIEM > 100) {
            alert('T·ªïng ƒëi·ªÉm ph·∫£i t·ª´ 0 ƒë·∫øn 100.');
            return;
        }
        if (!['Xu·∫•t s·∫Øc', 'T·ªët', 'Kh√°', 'Trung b√¨nh', 'Y·∫øu'].includes(XEPLOAI)) {
            alert('X·∫øp lo·∫°i ph·∫£i l√†: Xu·∫•t s·∫Øc, T·ªët, Kh√°, Trung b√¨nh, ho·∫∑c Y·∫øu.');
            return;
        }

        const method = document.getElementById('saveButton').textContent.includes('C·∫≠p nh·∫≠t') ? 'PUT' : 'POST';
        const url = method === 'POST' ? '/api/phieudiem' : `/api/phieudiem/${IDSINHVIEN}/${IDHOCKY}/${IDDANHGIA}`;

        const formData = new URLSearchParams({
            IDSINHVIEN,
            IDHOCKY,
            IDDANHGIA,
            TONGDIEM: TONGDIEM.toString(),
            XEPLOAI,
            GHICHU
        });

        try {
            const res = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: formData
            });

            if (res.ok) {
                alert(method === 'POST' ? 'Th√™m phi·∫øu ƒëi·ªÉm th√†nh c√¥ng!' : 'C·∫≠p nh·∫≠t phi·∫øu ƒëi·ªÉm th√†nh c√¥ng!');
                clearForm();
                loadPhieuDiem();
            } else {
                const errorData = await res.json();
                alert('L·ªói: ' + (errorData.detail || 'Kh√¥ng th·ªÉ th·ª±c hi·ªán y√™u c·∫ßu'));
            }
        } catch (error) {
            alert('L·ªói khi g·ª≠i y√™u c·∫ßu: ' + (error.message || 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server'));
        }
    }

    function editPhieuDiem(IDSINHVIEN, IDHOCKY, IDDANHGIA, TONGDIEM, XEPLOAI, GHICHU) {
        document.getElementById('IDSINHVIEN').value = IDSINHVIEN;
        document.getElementById('IDHOCKY').value = IDHOCKY;
        document.getElementById('IDDANHGIA').value = IDDANHGIA;
        document.getElementById('TONGDIEM').value = TONGDIEM;
        document.getElementById('XEPLOAI').value = XEPLOAI;
        document.getElementById('GHICHU').value = GHICHU;
        document.getElementById('saveButton').textContent = 'üìù C·∫≠p nh·∫≠t';
        document.getElementById('cancelButton').classList.remove('hidden');
    }

    async function deletePhieuDiem(IDSINHVIEN, IDHOCKY, IDDANHGIA) {
        if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a phi·∫øu ƒëi·ªÉm c·ªßa sinh vi√™n ${IDSINHVIEN} trong h·ªçc k·ª≥ ${IDHOCKY}?`)) {
            try {
                const res = await fetch(`/api/phieudiem/${IDSINHVIEN}/${IDHOCKY}/${IDDANHGIA}`, { method: 'DELETE' });
                if (res.ok) {
                    alert('X√≥a phi·∫øu ƒëi·ªÉm th√†nh c√¥ng!');
                    loadPhieuDiem();
                } else {
                    const errorData = await res.json();
                    alert('L·ªói khi x√≥a: ' + (errorData.detail || 'Kh√¥ng th·ªÉ x√≥a phi·∫øu ƒëi·ªÉm'));
                }
            } catch (error) {
                alert('L·ªói khi g·ª≠i y√™u c·∫ßu x√≥a: ' + (error.message || 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server'));
            }
        }
    }

    function clearForm() {
        document.getElementById('IDSINHVIEN').value = '';
        document.getElementById('IDHOCKY').value = '';
        document.getElementById('IDDANHGIA').value = '';
        document.getElementById('TONGDIEM').value = '';
        document.getElementById('XEPLOAI').value = '';
        document.getElementById('GHICHU').value = '';
        document.getElementById('saveButton').textContent = 'üíæ L∆∞u';
        document.getElementById('cancelButton').classList.add('hidden');
    }

    window.onload = async () => {
        await loadSinhVienDropdown();
        await loadHocKyDropdown();
        await loadDanhGiaDropdown();
        await loadPhieuDiem();
    };
</script>
</body>
</html>